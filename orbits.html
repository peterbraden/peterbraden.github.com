<html>
	<head>
		<script src = 'http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js'></script>

		<style type = "text/css">
		</style>
		
		<script type="text/javascript">


var orbits = {};
orbits.ui = {};
orbits.draw={};

orbits.draw.fillcircle = function(ctx, pos, rad, color){
	ctx.fillStyle = color;
	ctx.beginPath(); 
	ctx.arc(pos[0],pos[1],rad,0,Math.PI*2,true);
	ctx.fill(); 
}

orbits.ui.objs = [];

orbits.gameLoop = function(screen, ctx, tdiff){
	
	//Background
	ctx.fillStyle = "rgba(30,30,30,0.2)";
	ctx.fillRect (0, 0, screen.width, screen.height);
	
	//Objects
	$.each(orbits.objects, function(){
		this.move(tdiff);
		this.draw(ctx);	
	});	
	
	// UI
	$.each(orbits.ui.objs, function(){
		this.draw(ctx);
	});
}
		

orbits.vectorLength = function(vec){
	return Math.sqrt(vec[0]*vec[0]+ vec[1]*vec[1]);
}
orbits.vectorScale = function(p1, scale){
	return [p1[0] * scale, p1[1] * scale];
}
orbits.vectorNormalise = function(r){
	var len = orbits.vectorLength(r);
	return [r[0]/len, r[1]/len]
}
orbits.vectorAdd = function(p1, p2){
	return [p1[0] + p2[0], p1[1]+ p2[1]];
}
orbits.vectorSubtract = function(p1, p2){
	return [p1[0] - p2[0], p1[1] - p2[1]];
}

orbits.planet = function(x, y, radius, color){
	return {
		x: x,
		y: y,
		heading: [0,0],
		gravity: radius*radius,
		color: color,
		draw: function(ctx){
				orbits.draw.fillcircle(ctx, [this.x, this.y], radius, color);
				
				//ctx.fillStyle = "#f33";
				//var i = this.heading
				//ctx.fillRect(this.x + i[0], this.y + i[1], 5,5); 
			},
		move: function(tdiff){},
		grav_v: function(pos){
			var x = orbits.vectorSubtract([this.x, this.y], pos);
			var xl = orbits.vectorLength(x);
			return orbits.vectorScale(x, (1.0/(xl*xl)) * this.gravity);
		},
		intersects: function(pos, rad){
			return (orbits.vectorLength(orbits.vectorSubtract([this.x, this.y], pos))< radius+rad)
		},
	}
}		

orbits.moon = function(x, y, heading, radius, color){
	var o = orbits.planet(x, y, radius, color);
	o.heading = heading;
	o.gravity = 0;
	o.move = function(tdiff){
		var grav_v = [0,0];
		$.each(orbits.objects, function(){
			if (this != o){
				if (this.intersects([o.x, o.y], radius)){
					$.each(orbits.objects, function(x){if(this == o){orbits.objects.splice(x, 1);}});
				}
				grav_v = orbits.vectorAdd(grav_v, this.grav_v([o.x, o.y]));	
			}
		});
		var heading = orbits.vectorAdd(grav_v, o.heading); 
		var curr_vec = orbits.vectorScale(heading, 1);
		o.heading = heading;
		o.x += curr_vec[0]/tdiff;
		o.y += curr_vec[1]/tdiff;
		
	};
	
	
	return o;
}



orbits.ui.slingshot = function(st){
	
	s = {
		start:st,
		finish:st,
		
		bind : function(jelem){
			jelem.mousedown(function(e){
				s.start = [e.clientX, e.clientY];
				orbits.ui.objs.push(s);
			}).mouseup(function(e){
				var h = orbits.vectorSubtract(s.start, [e.clientX, e.clientY]);
				orbits.objects.push(
					orbits.moon(s.start[0], s.start[1], orbits.vectorScale(h, orbits.vectorLength(h)), 10, '#f0f')
				);
			});	
		},
		
		draw: function(ctx){
			orbits.draw.fillcircle(ctx, this.start, 1, '#f00');
		}
			
	};
	return s	
}		
		
$(function(){		
	var screen = $("#orbits")[0];
	var ctx = screen.getContext('2d');

	orbits.objects = [
		orbits.planet(100.0,250.0,50.0,'#999'),
		orbits.planet(300.0,250.0,50.0,'#999'),

		//orbits.moon(50.0, 50.0, [15000,-40], 10.0, '#f00'),
	];

	var time = 0;	
	setInterval(
		function(){
			orbits.gameLoop(screen, ctx, 1000);
		}, 10);
	
	var ss = orbits.ui.slingshot([-10, -10])
	ss.bind($(screen));
});	

		
		</script>

	</head>
	<body>
		<canvas width = '500' height='500' id = 'orbits' />
	</body>
</html>	